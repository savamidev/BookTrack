name: Registrar Usuario

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Nombre del usuario'
        required: true
      surname:
        description: 'Apellidos del usuario'
        required: true
      birthdate:
        description: 'Fecha de nacimiento (DD/MM/AAAA)'
        required: true
      email:
        description: 'Correo electr칩nico'
        required: true
      notifications:
        description: 'Aceptar notificaciones (S칤/No)'
        required: true

jobs:
  register-user:
    runs-on: ubuntu-latest

    steps:
      # ... (paso 1-5 permanecen iguales)

      # 6. Crear o actualizar el README.md global con la lista de usuarios
      - name: Crear o actualizar README.md global
        run: |
          README="Usuarios/README.md"

          # Si el archivo README.md no existe, crearlo
          if [ ! -f "$README" ]; then
            echo "# 游닄 **Lista de Usuarios Registrados**" > "$README"
            echo "" >> "$README"
          fi

          # A침adir el nuevo usuario al README.md
          echo "## ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}" >> $README
          echo "- **ID 칰nico**: $user_id" >> $README
          echo "- **Correo electr칩nico**: ${{ github.event.inputs.email }}" >> $README
          echo "" >> $README

      # 7. Eliminar subm칩dulo si existe
      - name: Eliminar subm칩dulo si existe
        run: |
          git submodule deinit --force "Usuarios/Miguel_S치nchez V치zquez"
          git rm --cached "Usuarios/Miguel_S치nchez V치zquez"
          git commit -m "Eliminar subm칩dulo rastreado pero eliminado"

      # 8. Limpiar 칤ndice Git
      - name: Limpiar 칤ndice Git
        run: |
          git filter-branch --force --index-filter \
            'git rm -r --cached --ignore-unmatch "Usuarios/Miguel_S치nchez V치zquez"' \
            --prune-empty --tag-name-filter cat -- --all

      # 9. Actualizar .gitignore
      - name: Actualizar .gitignore
        run: |
          echo "Usuarios/*_V치zquez/*" >> .gitignore
          git add .gitignore
          git commit -m "Actualizar .gitignore para evitar rastrear carpetas con V치zquez"

      # 10. Commit y push de los cambios
      - name: Commit y push de los cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # A침adir todos los archivos modificados
          git add "Usuarios/users.json" "Usuarios/README.md"
          
          # Generar el mensaje de commit din치micamente
          commit_message="Actualizar estructura de usuarios y limpiar 칤ndice Git"
          git commit -m "$commit_message"

          # Realizar el push con el token de autenticaci칩n
          git push origin main --force
