name: Registrar Usuario

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Nombre del usuario'
        required: true
      surname:
        description: 'Apellidos del usuario'
        required: true
      birthdate:
        description: 'Fecha de nacimiento (DD/MM/AAAA)'
        required: true
      email:
        description: 'Correo electrÃ³nico'
        required: true
      notifications:
        description: 'Aceptar notificaciones (SÃ­/No)'
        required: true

jobs:
  register-user:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 2. Generar el ID Ãºnico del usuario
      - name: Generar ID Ãºnico
        id: generate-id
        run: |
          user_id=$(echo "${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}_$(date +%s)" | tr '[:upper:]' '[:lower:]' | tr ' ' '_')
          echo "user_id=$user_id" >> $GITHUB_ENV

      # 3. Crear la carpeta personal del usuario y el README.md
      - name: Crear carpeta y README.md del usuario
        run: |
          user_dir="Usuarios/${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}"
          user_dir=$(echo "$user_dir" | tr '[:upper:]' '[:lower:]' | tr ' ' '_')  # Convertir a minÃºsculas y reemplazar espacios
          mkdir -p "$user_dir"  # Crear la carpeta del usuario
          user_readme="$user_dir/README.md"

          # Crear el README.md del usuario
          echo "# ðŸŽ‰ Bienvenido, ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}!" > "$user_readme"
          echo "" >> "$user_readme"
          echo "Â¡Hola, ${{ github.event.inputs.name }}! ðŸ˜Ž" >> "$user_readme"
          echo "Te damos la bienvenida a tu espacio personal en **BookTrack**, tu lugar para organizar, compartir y explorar tus lecturas. ðŸ“šâœ¨" >> "$user_readme"
          echo "" >> "$user_readme"
          echo "## ðŸ“‹ **Tus Datos**" >> "$user_readme"
          echo "- **Nombre completo**: ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}" >> "$user_readme"
          echo "- **ID Ãºnico**: **$user_id** (âš ï¸ Usa este ID para aÃ±adir libros a tu perfil)" >> "$user_readme"
          echo "- **Fecha de nacimiento**: ${{ github.event.inputs.birthdate }}" >> "$user_readme"
          echo "- **Correo electrÃ³nico**: ${{ github.event.inputs.email }}" >> "$user_readme"
          echo "- **Notificaciones**: ${{ github.event.inputs.notifications }}" >> "$user_readme"
          echo "" >> "$user_readme"
          echo "## ðŸš€ **PrÃ³ximos pasos**" >> "$user_readme"
          echo "1. ðŸŒŸ **Personaliza tu perfil**: Agrega tus lecturas en la carpeta `Usuarios/`." >> "$user_readme"
          echo "2. ðŸ“– **Explora clubes de lectura**: Ãšnete y comparte tus libros favoritos." >> "$user_readme"
          echo "3. ðŸŽ¯ **DesafÃ­os grupales**: Participa en retos mensuales." >> "$user_readme"
          echo "" >> "$user_readme"
          echo "Â¡Estamos muy emocionados de tenerte aquÃ­, ${{ github.event.inputs.name }}! Que tus lecturas sean infinitas y siempre encuentres tu prÃ³xima gran historia. ðŸ“–âœ¨" >> "$user_readme"

      # 4. Actualizar el archivo `users.json` con los datos del usuario
      - name: Actualizar archivo users.json
        run: |
          user_data=$(jq -n \
            --arg id "$user_id" \
            --arg name "${{ github.event.inputs.name }}" \
            --arg surname "${{ github.event.inputs.surname }}" \
            --arg birthdate "${{ github.event.inputs.birthdate }}" \
            --arg email "${{ github.event.inputs.email }}" \
            --arg notifications "${{ github.event.inputs.notifications }}" \
            '{id: $id, name: $name, surname: $surname, birthdate: $birthdate, email: $email, notifications: $notifications}')

          # Verificar si `users.json` ya existe
          if [ -f Usuarios/users.json ]; then
            jq --argjson new_user "$user_data" '.users += [$new_user]' Usuarios/users.json > temp.json && mv temp.json Usuarios/users.json
          else
            # Si no existe, crearlo
            echo '{"users":['"$user_data"']}' > Usuarios/users.json
          fi

      # 5. Actualizar el README.md general
      - name: Actualizar README.md general
        run: |
          readme="Usuarios/README.md"

          # Crear el archivo si no existe
          if [ ! -f "$readme" ]; then
            echo "# ðŸ“š **Lista de Usuarios Registrados**" > $readme
            echo "" >> $readme
          fi

          # Agregar informaciÃ³n del nuevo usuario
          echo "## ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}" >> $readme
          echo "- **ID Ãºnico**: $user_id" >> $readme
          echo "- **Correo electrÃ³nico**: ${{ github.event.inputs.email }}" >> $readme
          echo "" >> $readme

      # 6. Hacer commit y push de los cambios
      - name: Commit y push de los cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Verificar que los archivos existen antes de hacer commit
          git add Usuarios/users.json
          git add Usuarios/README.md
          git add "Usuarios/${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}/README.md"

          git commit -m "Nuevo usuario registrado: ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }} (ID: $user_id)"
          git push
