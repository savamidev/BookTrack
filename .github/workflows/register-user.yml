name: Registrar Usuario

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Nombre del usuario'
        required: true
      surname:
        description: 'Apellidos del usuario'
        required: true
      birthdate:
        description: 'Fecha de nacimiento (DD/MM/AAAA)'
        required: true
      email:
        description: 'Correo electrónico'
        required: true
      notifications:
        description: 'Aceptar notificaciones (Sí/No)'
        required: true

jobs:
  register-user:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 2. Instalar Node.js (necesario para usar jq)
      - name: Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # 3. Registrar el usuario
      - name: Registrar usuario
        run: |
          # Crear el objeto del nuevo usuario
          USER=$(jq -n \
            --arg name "${{ github.event.inputs.name }}" \
            --arg surname "${{ github.event.inputs.surname }}" \
            --arg birthdate "${{ github.event.inputs.birthdate }}" \
            --arg email "${{ github.event.inputs.email }}" \
            --arg notifications "${{ github.event.inputs.notifications }}" \
            '{name: $name, surname: $surname, birthdate: $birthdate, email: $email, notifications: $notifications}')

          # Leer el contenido actual de users.json
          EXISTING_USERS=$(cat BBDD/users.json)

          # Añadir el nuevo usuario al archivo
          UPDATED_USERS=$(echo $EXISTING_USERS | jq --argjson user "$USER" '.users += [$user]')

          # Guardar el contenido actualizado en users.json
          echo "$UPDATED_USERS" > BBDD/users.json

      # 4. Hacer commit de los cambios
      - name: Commit y push de los cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add users.json
          git commit -m "Nuevo usuario registrado: ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}"
          git push

