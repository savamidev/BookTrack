name: Registrar Usuario

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Nombre del usuario'
        required: true
      surname:
        description: 'Apellidos del usuario'
        required: true
      birthdate:
        description: 'Fecha de nacimiento (DD/MM/AAAA)'
        required: true
      email:
        description: 'Correo electrónico'
        required: true
      notifications:
        description: 'Aceptar notificaciones (Sí/No)'
        required: true

jobs:
  register-user:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 2. Generar una ID corta y única (3 dígitos)
      - name: Generar ID corto
        id: generate-id
        run: |
          user_id=$(openssl rand -base64 2 | tr -dc '0-9a-zA-Z' | cut -c1-3)  # ID de 3 caracteres
          echo "user_id=$user_id" >> $GITHUB_ENV

      # 3. Crear la carpeta personal para el usuario dentro de `Usuarios`
      - name: Crear carpeta personal para el usuario
        run: |
          user_dir="Usuarios/${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}"
          user_dir=${user_dir// /_}  # Reemplazar espacios por guiones bajos
          mkdir -p "$user_dir"  # Crear la carpeta del usuario si no existe

      # 4. Guardar los datos del usuario en `Usuarios/users.json`
      - name: Guardar los datos del usuario en `users.json`
        run: |
          user_data=$(jq -n \
            --arg id "$user_id" \
            --arg name "${{ github.event.inputs.name }}" \
            --arg surname "${{ github.event.inputs.surname }}" \
            --arg birthdate "${{ github.event.inputs.birthdate }}" \
            --arg email "${{ github.event.inputs.email }}" \
            --arg notifications "${{ github.event.inputs.notifications }}" \
            '{id: $id, name: $name, surname: $surname, birthdate: $birthdate, email: $email, notifications: $notifications}')

          # Si `users.json` ya existe, agregar el nuevo usuario
          if [ -f Usuarios/users.json ]; then
            jq --argjson new_user "$user_data" '.users += [$new_user]' Usuarios/users.json > temp.json && mv temp.json Usuarios/users.json
          else
            # Si no existe, crear uno nuevo
            echo '{"users":['"$user_data"']}' > Usuarios/users.json
          fi

      # 5. Crear un `README.md` personalizado dentro de la carpeta del usuario
      - name: Crear README.md personal para el usuario
        run: |
          user_dir="Usuarios/${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}"
          user_dir=${user_dir// /_}  # Reemplazar espacios por guiones bajos
          user_readme="$user_dir/README.md"

          # Crear el archivo README.md para el usuario con estilo creativo
          echo "# 🎉 ¡Bienvenido, ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}!" > "$user_readme"
          echo "" >> "$user_readme"
          echo "¡Hola, ${{ github.event.inputs.name }}! 😎" >> "$user_readme"
          echo "Te damos la bienvenida a tu espacio personal en **BookTrack**, donde podrás organizar y explorar tus lecturas. 📚✨" >> "$user_readme"
          echo "" >> "$user_readme"
          echo "## 📋 **Tus Datos**" >> "$user_readme"
          echo "- **Nombre completo**: ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}" >> "$user_readme"
          echo "- **ID único**: **$user_id** (⚠️ Usa este ID para añadir libros a tu perfil)" >> "$user_readme"
          echo "- **Fecha de nacimiento**: ${{ github.event.inputs.birthdate }}" >> "$user_readme"
          echo "- **Correo electrónico**: ${{ github.event.inputs.email }}" >> "$user_readme"
          echo "- **Notificaciones**: ${{ github.event.inputs.notifications }}" >> "$user_readme"
          echo "" >> "$user_readme"
          echo "## 🚀 **Próximos pasos**" >> "$user_readme"
          echo "1. 🌟 **Personaliza tu perfil**: Agrega tus lecturas en la carpeta `Usuarios/`." >> "$user_readme"
          echo "2. 📖 **Explora clubes de lectura**: Únete y comparte tus libros favoritos." >> "$user_readme"
          echo "3. 🎯 **Desafíos grupales**: Participa en retos mensuales." >> "$user_readme"
          echo "" >> "$user_readme"
          echo "¡Estamos muy emocionados de tenerte aquí, ${{ github.event.inputs.name }}! Que tus lecturas sean infinitas y siempre encuentres tu próxima gran historia. 📖✨" >> "$user_readme"

      # 6. Crear o actualizar el `README.md` general con la lista de usuarios
      - name: Crear o actualizar README.md general
        run: |
          README="Usuarios/README.md"

          # Si el archivo README.md global no existe, crearlo
          if [ ! -f "$README" ]; then
            echo "# 📚 **Lista de Usuarios Registrados**" > "$README"
            echo "" >> "$README"
          fi

          # Añadir los datos del nuevo usuario
          echo "## ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }}" >> $README
          echo "- **ID único**: $user_id" >> $README
          echo "- **Correo electrónico**: ${{ github.event.inputs.email }}" >> $README
          echo "" >> $README

      # 7. Hacer commit y push de los cambios
      - name: Commit y push de los cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Añadir todos los archivos modificados (incluyendo los README.md de usuario y global)
          git add "Usuarios/users.json" "Usuarios/README.md" "Usuarios/${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}/README.md"

          # Verificar que los archivos existen antes de hacer commit
          if [ -f "Usuarios/users.json" ] && [ -f "Usuarios/README.md" ] && [ -f "Usuarios/${{ github.event.inputs.name }}_${{ github.event.inputs.surname }}/README.md" ]; then
            commit_message="Nuevo usuario registrado: ${{ github.event.inputs.name }} ${{ github.event.inputs.surname }} (ID: $user_id)"
            git commit -m "$commit_message"
            git push
          else
            echo "Error: No se encontraron los archivos necesarios para el commit."
            exit 1
          fi
