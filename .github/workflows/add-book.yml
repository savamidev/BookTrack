name: Gestionar Base de Datos de Libros

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'T√≠tulo del libro'
        required: true
      author:
        description: 'Autor del libro'
        required: true
      genre:
        description: 'G√©nero literario'
        required: true
      year:
        description: 'A√±o de publicaci√≥n'
        required: true
      status:
        description: 'Estado del libro'
        required: true
        type: choice
        options:
          - Pendiente
          - En lectura
          - Acabado
      favorite:
        description: '¬øEs uno de tus libros favoritos?'
        required: false
        type: boolean

jobs:
  manage-books:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 2. Registrar el libro en la categor√≠a seleccionada
      - name: Registrar libro
        run: |
          # Seleccionar el archivo correspondiente seg√∫n el estado
          case "${{ github.event.inputs.status }}" in
            Pendiente) file="Libros/pendientes.json" ;;
            "En lectura") file="Libros/en_lectura.json" ;;
            Acabado) file="Libros/acabados.json" ;;
            *) echo "Estado inv√°lido: ${{ github.event.inputs.status }}" && exit 1 ;;
          esac

          # Crear el objeto del libro
          BOOK=$(jq -n \
            --arg title "${{ github.event.inputs.title }}" \
            --arg author "${{ github.event.inputs.author }}" \
            --arg genre "${{ github.event.inputs.genre }}" \
            --arg year "${{ github.event.inputs.year }}" \
            '{title: $title, author: $author, genre: $genre, year: $year}')

          # A√±adir el libro a la categor√≠a seleccionada
          EXISTING=$(cat $file)
          UPDATED=$(echo $EXISTING | jq --argjson book "$BOOK" '.books += [$book]')
          echo "$UPDATED" > $file

          # Si es favorito, a√±adirlo tambi√©n a favoritos.json
          if [ "${{ github.event.inputs.favorite }}" == "true" ]; then
            FAVORITES=$(cat Libros/favoritos.json)
            UPDATED_FAVORITES=$(echo $FAVORITES | jq --argjson book "$BOOK" '.books += [$book]')
            echo "$UPDATED_FAVORITES" > Libros/favoritos.json
          fi

      # 3. Generar o actualizar el README con los libros registrados
      - name: Generar o actualizar README
        run: |
          README="Libros/README.md"

          # Crear un encabezado si el README no existe
          if [ ! -f "$README" ]; then
            echo "# üìö Base de Datos de Libros" > $README
            echo "" >> $README
          fi

          # Reiniciar contenido para actualizar el listado
          echo "# üìö Base de Datos de Libros" > $README
          echo "" >> $README

          for file in pendientes.json en_lectura.json acabados.json favoritos.json; do
            state=$(echo $file | sed 's/.json//' | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
            echo "## $state" >> $README
            echo "" >> $README
            jq -r '.books[] | "- **T√≠tulo**: \(.title)\n  - **Autor**: \(.author)\n  - **G√©nero**: \(.genre)\n  - **A√±o**: \(.year)"' Libros/$file >> $README
            echo "" >> $README
          done

      # 4. Hacer commit y push de los cambios
      - name: Commit y push de los cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # A√±adir los archivos modificados a la etapa de commit
          git add Libros/pendientes.json Libros/en_lectura.json Libros/acabados.json Libros/favoritos.json Libros/README.md

          # Generar el mensaje de commit din√°micamente
          commit_message="Libro registrado: ${{ github.event.inputs.title }} (Estado: ${{ github.event.inputs.status }}, Favorito: ${{ github.event.inputs.favorite }})"
          git commit -m "$commit_message"

          # Realizar el push con el token de autenticaci√≥n
          git push
