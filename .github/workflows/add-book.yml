name: Registrar Libro

on:
  workflow_dispatch:
    inputs:
      book_title:
        description: 'T칤tulo del libro'
        required: true
      book_author:
        description: 'Autor del libro'
        required: true
      book_status:
        description: 'Estado del libro'
        required: true
        type: choice
        options:
          - "Leyendo"
          - "Pendiente"
          - "Terminado"
      book_favorite:
        description: '쮼s tu libro favorito?'
        required: true
        type: choice
        options:
          - "Si"
          - "No"
      book_type:
        description: 'Tipo de libro (ej. Terror, Fantas칤a, etc.)'
        required: true
        type: choice
        options:
          - "Terror"
          - "Fantas칤a"
          - "Ciencia Ficci칩n"
          - "Misterio"
          - "Aventura"
          - "Rom치ntico"
      user_id:
        description: 'Ingresa el ID del usuario (Diferencias entre may칰sculas y min칰sculas)'
        required: true
        type: string

jobs:
  register-book:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 2. Instalar jq
      - name: Instalar jq
        run: sudo apt-get install -y jq

      # 3. Leer usuarios de users.json
      - name: Leer usuarios de users.json
        id: read_users
        run: |
          USERS=$(jq -r '.users[] | select(.id == "${{ github.event.inputs.user_id }}")' Usuarios/users.json)
          USER_NAME=$(echo "$USERS" | jq -r '.name')
          USER_SURNAME=$(echo "$USERS" | jq -r '.surname')
          USER_EMAIL=$(echo "$USERS" | jq -r '.email')
          echo "user_id=${{ github.event.inputs.user_id }}" >> $GITHUB_ENV
          echo "user_name=$USER_NAME" >> $GITHUB_ENV
          echo "user_surname=$USER_SURNAME" >> $GITHUB_ENV
          echo "user_email=$USER_EMAIL" >> $GITHUB_ENV

      # 4. Registrar el libro
      - name: Registrar el libro
        run: |
          book_data=$(jq -n \
            --arg title "${{ github.event.inputs.book_title }}" \
            --arg author "${{ github.event.inputs.book_author }}" \
            --arg status "${{ github.event.inputs.book_status }}" \
            --arg favorite "${{ github.event.inputs.book_favorite }}" \
            --arg book_type "${{ github.event.inputs.book_type }}" \
            --arg user_id "${{ env.user_id }}" \
            '{title: $title, author: $author, status: $status, favorite: $favorite, type: $book_type, user_id: $user_id}')

          case "${{ github.event.inputs.book_status }}" in
            Leyendo)
              target_file="Libros/en_lectura.json"
              ;;
            Pendiente)
              target_file="Libros/pendientes.json"
              ;;
            Terminado)
              target_file="Libros/acabados.json"
              ;;
            *)
              echo "Estado no v치lido, el libro no ser치 registrado."
              exit 1
              ;;
          esac

          if [ -f "$target_file" ]; then
            jq --argjson new_book "$book_data" '.books += [$new_book]' "$target_file" > temp.json && mv temp.json "$target_file"
          else
            echo '{"books":['"$book_data"']}' > "$target_file"
          fi

          books_json="Libros/books.json"
          if [ -f "$books_json" ]; then
            jq --argjson new_book "$book_data" '.books += [$new_book]' "$books_json" > temp.json && mv temp.json "$books_json"
          else
            echo '{"books":['"$book_data"']}' > "$books_json"
          fi

      # 5. Actualizar README.md en la carpeta Libros
      - name: Actualizar README.md en Libros
        run: |
          if [ ! -d "Libros" ]; then
            mkdir Libros
          fi

          LIBROS_README="Libros/README.md"
          if [ ! -f "$LIBROS_README" ]; then
            echo "# 游닄 Informaci칩n de Libros Registrados" > "$LIBROS_README"
            echo "" >> "$LIBROS_README"
          fi

          echo "## T칤tulo: ${{ github.event.inputs.book_title }}" >> "$LIBROS_README"
          echo "- **Autor**: ${{ github.event.inputs.book_author }}" >> "$LIBROS_README"
          echo "- **Estado**: ${{ github.event.inputs.book_status }}" >> "$LIBROS_README"
          echo "- **Favorito**: ${{ github.event.inputs.book_favorite }}" >> "$LIBROS_README"
          echo "- **Tipo**: ${{ github.event.inputs.book_type }}" >> "$LIBROS_README"
          echo "" >> "$LIBROS_README"

      # 6. Actualizar el README.md del usuario
      - name: Actualizar el README.md del usuario
        run: |
          USER_DIR="Usuarios/${{ env.user_name }}_${{ github.event.inputs.user_id }}"
          USER_README="$USER_DIR/README.md"

          if [ ! -d "$USER_DIR" ]; then
            echo "La carpeta del usuario no existe."
            exit 1
          fi

          if [ ! -f "$USER_README" ]; then
            echo "# 游닄 Perfil de ${{ env.user_name }} ${{ env.user_surname }}" > "$USER_README"
            echo "" >> "$USER_README"
            echo "- **Correo electr칩nico**: ${{ env.user_email }}" >> "$USER_README"
            echo "" >> "$USER_README"
          fi

          echo "## Libro A침adido: ${{ github.event.inputs.book_title }}" >> "$USER_README"
          echo "- **Autor**: ${{ github.event.inputs.book_author }}" >> "$USER_README"
          echo "- **Estado**: ${{ github.event.inputs.book_status }}" >> "$USER_README"
          echo "- **Favorito**: ${{ github.event.inputs.book_favorite }}" >> "$USER_README"
          echo "- **Tipo**: ${{ github.event.inputs.book_type }}" >> "$USER_README"
          echo "" >> "$USER_README"

      # 7. Hacer commit y push de los cambios
      - name: Commit y push de los cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Libros/books.json Libros/README.md "Usuarios/${{ env.user_name }}_${{ env.user_id }}/README.md"
          git commit -m "Registrar libro para ${{ env.user_name }} ${{ env.user_surname }}"
          git push

